---
title: "COVID19 Weekly Trust Reporting"
output:
  flexdashboard::flex_dashboard:
    logo: "./img/phe-white-48.png"
    css: "gov_style.css"
runtime: shiny
---


```{r global, include=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
library(tidyverse)
library(lubridate)
library(flexdashboard)
library(plotly)
library(shiny)
library(DT)
library(readxl)
library(govdown)
library(shinyGovstyle)

hcai <- read_csv("./hcai.csv") 
trust_names <- read_csv("./lookup/trust_names.csv")

## disable scientific notation
options(scipen = 999)

## PHE Colour Palette
phe_colours <- c("#822433","#00B092","#EAAB00",
                 "#003087","#425563","#8CB8C6",
                 "#330072","#006747","#E8EDEE",
                 "#005EB8","#FAE100","#DAD7CB",
                 "#0072CE","#E9994A","#78BE20")


hcai <- left_join(hcai,trust_names,by=c("provider_code"="trust_code"))

hcai <- hcai %>% 
  mutate(wk_start=ymd(wk_start),
         ecds_last_update=ymd(ecds_last_update),
         sus_last_update=ymd(sus_last_update),
         hcai_group=if_else(grepl("CO",hcai_group),"CO",hcai_group),
         hcai_group=factor(hcai_group,
                  levels = c("Unlinked",
                             "CO",
                             "HO.iHA",
                             "HO.pHA",
                             "HO.HA"))) %>% 
  mutate(nhs_region=factor(nhs_region,
                           levels=c(
                             "LONDON",
                             "SOUTH EAST",
                             "SOUTH WEST",
                             "EAST OF ENGLAND",
                             "MIDLANDS",
                             "NORTH EAST AND YORKSHIRE",
                             "NORTH WEST"
                           ))) %>% 
  mutate(provider_code=if_else(is.na(trust_name),NA_character_,provider_code),
         provider_code=fct_explicit_na(factor(provider_code),"Unknown"),
         trust_name=fct_explicit_na(factor(trust_name),"Unknown"),
         trust_type=fct_explicit_na(factor(trust_type),"Unknown"),
         nhs_region=fct_explicit_na(factor(nhs_region),"Unknown"),
         hcai_group=fct_explicit_na(hcai_group,"Unlinked"),
         linkset=if_else(hcai_group=="Unlinked","SGSS",linkset)
         ) 

## font stylings for plotlys
font_style <- list(
  family = "Arial",
  size = 14,
  color = "black"
)

```

Sidebar {.sidebar}
=======================================================================

```{r inputs}
## SETUP INPUTS ON TYPE, GEOGRPAHY, CODE & NAME
selectInput("nhs_region",
                   label = "NHS Region",
                   choices = c("ALL",levels(droplevels(factor(hcai$nhs_region),
                                                       exclude="Unknown"))),
                   selected = c("ALL"))

selectInput("trust_type",
                   label = "Trust type",
                   choices = c("ALL",levels(droplevels(factor(hcai$trust_type),
                                                       exclude="Unknown"))),
                   selected = c("ALL"))

selectInput("trust_code",
            label = "Trust code",
            choices = c("ALL", levels(factor(hcai$provider_code))))

selectInput("trust_name",
            label = "Trust Name",
            choices = c("ALL", levels(factor(hcai$trust_name))))

## linked cases
selectInput("link",
            label = "Case inclusion",
            choices = c("Include unlinked cases"=1, "Linked cases only"=0),
            selected = c(1))

## DATE FILTERS
dateInput("filterdate", 
          label="Filter dates before", 
          min = min(hcai$wk_start),
          max = max(hcai$wk_start),
          value = "2020-03-01"
          )
```

    
```{r reactive_data_dashboard}

#### DASHBOARD DATA #############################################################
unfiltered <- reactive({
  ## filter dates always
  d <- hcai %>% 
    filter(wk_start >= as.Date(input$filterdate)) %>% 
    ungroup()
  
  ## NHS region
  if (input$nhs_region == "ALL") {
    d <- d
    
  } else {
    d <- d %>% filter(nhs_region == as.character(input$nhs_region))
    
  }
  
  ## trust type
  if (input$trust_type == "ALL") {
    d <- d
    
  } else {
    d <- d %>% filter(trust_type == as.character(input$trust_type))
    
  }
  
  ## deal with linked/unlinked data
  if (input$link == 0) {
    d <- d %>% filter(hcai_group != "Unlinked")
    
  } else {
    d <- d
  }
  
})

data <- reactive({
  
  d <- unfiltered()
  
   ## trust code
  if (input$trust_code == "ALL") {
    d <- d %>% mutate(provider_code = "ALL")
    
  } else {
    d <- d %>% filter(provider_code == as.character(input$trust_code))
  }
  
})
```


```{r select_updates}

## update menus
observeEvent(input$nhs_region, {

    updateSelectInput(
      session = session,
      inputId = "trust_name",
      choices = c("ALL",levels(factor(unfiltered()$trust_name)))
    )
    updateSelectInput(
      session = session,
      inputId = "trust_code",
      choices = c("ALL",levels(factor(unfiltered()$provider_code)))
    )
    
})


observeEvent(input$trust_type, {
  
  updateSelectInput(
    session = session,
    inputId = "trust_code",
    choices = c("ALL",levels(factor(unfiltered()$provider_code)))
    )
  updateSelectInput(
    session = session,
    inputId = "trust_name",
    choices = c("ALL",levels(factor(unfiltered()$trust_name)))
  )
}
)

observeEvent(input$trust_code,{
  
  if (input$trust_code != "ALL") {
    t <- unfiltered() %>% filter(provider_code == input$trust_code)
    
    updateSelectInput(
      session = session,
      inputId = "trust_name",
      selected = c(levels(factor(as.character(t$trust_name))))
    )
    
  } else {
    updateSelectInput(session = session,
                      inputId = "trust_name",
                      selected = c("ALL"))
  }
}
)

observeEvent(input$trust_name, {
  if (input$trust_name != "ALL") {
    t <- unfiltered() %>% filter(trust_name == input$trust_name)
    
    updateSelectInput(
      session = session,
      inputId = "trust_code",
      selected = c(as.character(t$provider_code))
    )

  } else {
    updateSelectInput(session = session,
                      inputId = "trust_name",
                      selected = c("ALL"))

  }
})




```

The HCAI categories are as follows:

  + __CO__: Community Onset
  + __HO.iHA__: Hospital-Onset Indeterminate Healthcare-Associated
  + __HO.pHA__: Hospital-Onset Probable Healthcare-Associated
  + __HO.HA__: Hospital-Onset Healthcare-Associated
  + __Unlinked__: Unlinked COVID19 Positive Specimen


Home {data-orientation=rows}
=======================================================================

> __NOTE: Dashboard currently in development__


This dashboard shows the location at where a patient was when they had their first COVID-19 positive PCR test, in relation to a hospital attendance in A&E or inpatient admission.

This therefore, does not always reflect where a patient has ultimately recieved inpatient care.

For example, where a patient attended A&E in Trust 1 and was tested positive, then two days later was admitted as an inpatient in Trust 2, this dashboard will assign them to Trust 1.


Please note that these data are purely for __PHE internal testing purposes only__ and are not fit for reporting or analysis at this time.

Unlinked caess are assigned a trust based on the lab which undertook the test, this will result in some trusts having unlinked cases from smaller surrounding hospitals shown in grey



Dashboard {data-orientation=rows}
=======================================================================

```{r reactive_data_valuebox }
#### VALUE BOX INDICATOR DATA ###################################################
vb_data <- reactive({
  
  
  ## NHS region
  if(input$nhs_region=="ALL"){
    vb <- hcai %>% 
      ungroup() 
  
  } else {
    vb <- hcai %>%
      ungroup() %>% 
      filter(nhs_region == as.character(input$nhs_region))
    
  }
  
  ## trust type
  if (input$trust_type == "ALL") {
    vb <- vb %>%
      ungroup()
    
  } else {
    vb <- vb %>%
      ungroup() %>%
      filter(trust_type == as.character(input$trust_type))
    
  }
  
  ## trust code
  if (input$trust_code == "ALL") {
    vb <- vb 
    
  } else {
    vb <- vb %>%
      filter(provider_code == as.character(input$trust_code))
  }
  
  ## group up data
  vb <- vb %>%
    mutate(linkgrp = hcai_group != "Unlinked") %>%
    group_by(linkgrp, hcai_group) %>%
    summarise(n = sum(n),.groups="drop") %>%
    group_by(linkgrp) %>%
    mutate(link_t = sum(n),
           link_p = round(n / link_t * 100, 1)) %>%
    ungroup() %>%
    mutate(t = sum(n),
           p = round(n / t * 100, 1)) 
})

```


Row 
-----------------------------------------------------------------------

### Total cases {.value-box}

```{r vb_total}

renderValueBox({
  if (input$link == 1) {
    valueBox(
      value = sum(vb_data()$n),
      icon = "fa fa-signal",
      caption = paste(
        "Cases between","<br/>",
        format(as.Date(input$filterdate),"%d %b %Y"),
        "and","<br/>",
        format(as.Date(file.info("./hcai.csv")$mtime),"%d %b %Y")
      ),
      color = "#003087"
    )
  } else {
    valueBox(
      value = sum(vb_data()$n[vb_data()$linkgrp]),
      icon = "fa fa-signal",
      caption = paste(
        "Cases between","<br/>",
        format(as.Date(input$filterdate),"%d %b %Y"),
        "and","<br/>",
        format(as.Date(file.info("./hcai.csv")$mtime),"%d %b %Y")
      ),
      color = "#003087"
    )
  }

})
```

### Cases in the last 4 weeks {.value-box}

```{r vb_last4}

renderValueBox({
  
    cases_last4 <- data() %>%
      group_by(wk, linkset, hcai_group) %>%
      summarise(n = sum(n),.groups="drop") %>%
      mutate(recent = wk >= max(wk)) %>%
      group_by(recent) %>%
      summarise(n = sum(n),.groups="drop") %>%
      mutate(p = round(n / sum(n) * 100, 1))
    
    valueBox(
      value = ifelse(is.na(cases_last4$n[2]),0,cases_last4$n[2]),
      icon = "fa fa-calendar",
      caption = paste("Cases in week starting",format(max(data()$wk_start),"%d %b %Y")),
      color = "#003087"
    )
})
```

### Proportion with temporal link {.value-box}

```{r vb_link_percent}

# renderGauge({
# gauge(sum(vb_data()$p[vb_data()$linkgrp])
#       , 
#       min = 0, 
#       max = 100, 
#       symbol = '%', 
#       gaugeSectors(
#         success = c(80, 100), 
#         warning = c(40, 79), 
#         danger = c(0, 39)
# ))
#   
# })
# 
renderValueBox({

    valueBox(
      value = paste0(sum(vb_data()$p[vb_data()$linkgrp]),
                     "%"),
      icon = "fa fa-link",
      caption = "of positive PCR COVID-19 tests linked",
      color = "#005EB8"
    )

})


```

### Last ECDS record {.value-box}

```{r vb_ecds_Date}

renderValueBox({

    valueBox(
      value = format(max(data()$ecds_last_update,na.rm=T),"%d %b"),
      icon = "fas fa-hospital-symbol",
      caption = paste(year(max(data()$ecds_last_update,na.rm=T)),
                      "<br/>",
                      "Latest A&E admission from ECDS"),
      color = "#005EB8"
    )

})
```

### Last SUS record {.value-box}

```{r vb_sus_Date}

renderValueBox({

    valueBox(
      value = format(max(data()$sus_last_update,na.rm=T),"%d %b"),
      icon = "fas fa-hospital-symbol",
      caption = paste(year(max(data()$sus_last_update,na.rm=T)),
                      "<br/>",
                      "Latest hospital discharge from SUS"),
      color = "#005EB8"
    )

})
```


### Proportion linked cases CO {.value-box}

```{r vb_CO.0_2}

### Proportion linked cases CO.pHA {.value-box}

# ```{r vb_CO14}
# 
# renderValueBox({
#   
#   valueBox(value = paste0(ifelse(
#     any(vb_data()$hcai_group == "CO.pHA"),
#     vb_data()$p[vb_data()$hcai_group == "CO.pHA"],
#     0
#   ),
#   "%"),
#   icon = "fa fa-home",
#   color = "#003087")
#   
# })
# ```

renderValueBox({
  
  valueBox(value = paste0(ifelse(
    any(vb_data()$hcai_group == "CO"),
    vb_data()$link_p[vb_data()$hcai_group == "CO"],
    0
  ),
  "%"),
  icon = "fa fa-home",
  color = "#00B092")
  
})
```

### Proportion linked cases HO.iHA {.value-box}

```{r vb_HO.3_7}
renderValueBox({
  
  valueBox(value = paste0(ifelse(
    any(vb_data()$hcai_group == "HO.iHA"),
    vb_data()$link_p[vb_data()$hcai_group == "HO.iHA"],
    0
  ),
  "%"),
  color = "#425563")
})
```

### Proportion linked cases HO.pHA {.value-box}

```{r vb_HO.8_14}
renderValueBox({
  
  valueBox(value = paste0(ifelse(
    any(vb_data()$hcai_group == "HO.pHA"),
    vb_data()$link_p[vb_data()$hcai_group == "HO.pHA"],
    0
  ),
  "%"),
  icon = "fas fa-hospital-symbol",
  color = "#EAAB00")
})
```

### Proportion linked cases HO.HA {.value-box}

```{r vb_HO.15}
renderValueBox({
  
  valueBox(value = paste0(ifelse(
    any(vb_data()$hcai_group == "HO.HA"),
    vb_data()$link_p[vb_data()$hcai_group == "HO.HA"],
    0
  ),
      "%"),
    icon = "fas fa-hospital-symbol",
    color = "#822433")
})
```


Row
-----------------------------------------------------------------------

### Figure 1: Counts per week

```{r plot_count}

renderPlotly({
  
  hcai_week <-
    data() %>%
    group_by(wk_start, hcai_group, provider_code) %>%
    summarise(n = sum(n),.groups = "keep")  %>% 
    ggplot(aes(x = wk_start,
               y = n,
               fill = hcai_group)) +
    geom_bar(stat = "identity",
             width=6) +
    scale_fill_manual(
      values = c(
        "Unlinked" = "#C3C3C3",
        "CO.pHA" = "#003087",
        "CO" = "#00B092",
        "HO.iHA" = "#425563",
        "HO.pHA" = "#EAAB00",
        "HO.HA" = "#822433"
      )
    ) +
    scale_x_date(
      "COVID19 Positive Test (Week Commencing; 2020)",
        breaks = seq(min(data()$wk_start)-7, max(data()$wk_start)+7, 7),
      date_labels = "%d %b",
      expand = expansion(add = 1)
    ) +
    scale_y_continuous("Total number of cases",
                       breaks = function(x, n = 5) pretty(x, n)[pretty(x, n) %% 1 == 0]) +
    theme_classic() +
    guides(fill = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")

  ggplotly(hcai_week) %>%
    layout(hovermode = "x unified",
           font=font_style) %>%
    config(displaylogo = FALSE,
           modeBarButtons = list(list("toImage"))) %>% 
    layout(legend = list(orientation = 'h',
                         y = '1.15',
                         title=list(text="HCAI category")
                         )) 
  
})

```


Row 
-----------------------------------------------------------------------

### Figure 2: Proportions per week

```{r plot_percent}


renderPlotly({
  
  if (input$trust_code=="ALL" & input$trust_type == "ALL" & input$link==1) {
    
    # give all data as proportion linked
    link_prop <- data() %>%
      group_by(linkset, wk_start, wk, provider_code) %>%
      summarise(n = sum(n),.groups="drop") %>%
      group_by(wk_start, wk, provider_code) %>%
      mutate(total = sum(n),
             p = round(n / total * 100, digits = 1)) %>%
      ggplot(aes(x = wk_start,
                 y = p,
                 fill = linkset)) +
      geom_bar(stat = "identity",
               width=6) +
      scale_x_date(
        "COVID19 Positive Test (Week Commencing; 2020)",
        breaks = seq(min(data()$wk_start)-7, max(data()$wk_start)+7, 7),
        date_labels = "%d %b",
        expand = expansion(add = 1)
      ) +
      scale_y_continuous("Proportion of cases (%)",
                         labels = function(x) paste0(x, "%")) +
      scale_fill_manual(
        values = c(
          "SGSS:SUS:ECDS" = "#002549",
          "SGSS:SUS" = "#005EB8",
          "SGSS:ECDS" = "#4c8ecd",
          "SGSS" = "#C3C3C3"
        )
      ) +
      theme_classic() +
      theme(legend.position = "bottom")
    
    ggplotly(link_prop) %>%
      layout(hovermode = "compare",
             font=font_style) %>%
      config(displaylogo = FALSE,
             modeBarButtons = list(list("toImage"))) %>% 
      layout(legend = list(orientation = 'h',
                         y = '1.15',
                         title=list(text="Datasets linked")
                         ))
  
  } else {
    
    ## or if one trust breakdown props per day since we cannot attribute unlinked
    hcai_week_p <-
      data() %>%
      group_by(wk_start, hcai_group, provider_code) %>%
      summarise(n = sum(n),.groups="drop") %>%
      group_by(wk_start, provider_code) %>%
      mutate(p = round(n / sum(n) * 100, 1)) %>%
      ggplot(aes(x = wk_start,
                 y = p,
                 fill = hcai_group)) +
      geom_bar(stat = "identity",
               width = 6) +
      scale_fill_manual(
        values = c(
          "Unlinked" = "#C3C3C3",
          "CO.pHA" = "#003087",
          "CO" = "#00B092",
          "HO.iHA" = "#425563",
          "HO.pHA" = "#EAAB00",
          "HO.HA" = "#822433"
        )
      ) +
      scale_x_date(
        "COVID19 Positive Test (Week Commencing; 2020)",
        breaks = seq(min(data()$wk_start)-7, max(data()$wk_start)+7, 7),
        date_labels = "%d %b",
        expand = expansion(add = 1)
      ) +
      scale_y_continuous("Proportion of cases (%)",
                         labels = function(x) paste0(x, "%")) +
      theme_classic() +
      guides(fill = guide_legend(nrow = 1)) +
      theme(legend.position = "bottom")
    
    ggplotly(hcai_week_p) %>% 
      layout(hovermode = "compare",
             font=font_style) %>% 
      config(displaylogo = FALSE,
             modeBarButtons = list(list("toImage"))) %>% 
      layout(legend = list(orientation = 'h',
                         y = '1.15',
                         title=list(text="HCAI category")
                         ))
  
  
  
    
  }
})

```

Data Table
=======================================================================

### Table 1: SGSS COVID 19 positive tests linked to hospital data by week

```{r datatable}

DT::renderDataTable({
  dt <- data() %>%
    group_by(wk_start, wk, hcai_group, provider_code) %>%
    summarise(n = sum(n),.groups="drop") %>%
    group_by(wk, wk_start) %>%
    mutate(wT = sum(n),
           p = n / wT) %>%
    arrange(hcai_group) %>% 
    pivot_wider(
      id_cols = c(wk, wk_start, wT),
      names_from = hcai_group,
      values_from = c(n, p),
      values_fill = list(n = 0, p = 0)
    ) %>%
    arrange(wk_start) %>%
    ungroup() %>%
    mutate(cT = cumsum(wT)) %>%
    arrange(desc(wk_start)) %>%
    select(
      wk,
      wk_start,
      Cumulative_Total = cT,
      wk_Total = wT,
      ends_with("CO.pHA"),
      ends_with("CO"),
      ends_with("HO.iHA"),
      ends_with("HO.pHA"),
      ends_with("HO.HA"),
      ends_with("Unlinked")
    )
  
  names(dt) <- sapply(sapply(strsplit(names(dt), "p_"), rev), paste, collapse="_%")
  names(dt) <- sapply(sapply(strsplit(names(dt), "n_"), rev), paste, collapse="_n")
  
    DT::datatable(dt,
                  extensions = 'Buttons',
                  options=list(pageLength=25,
                               dom = 'Bfrtip',
                               buttons=c('copy','csv')),
                  caption = paste(
                    "Data for",
                    case_when(
                      input$trust_name == "ALL" &
                        input$trust_type == "ALL" ~ "all Providers",
                      input$trust_name == "ALL" &
                        input$trust_type != "ALL" ~ paste("all",
                                                          input$trust_type,
                                                          "Providers"),
                      TRUE ~ input$trust_name
                    )),
                    
                  rownames = FALSE) %>% 
    DT::formatPercentage(grep("%",names(dt)),1)

})

```


Information
=======================================================================

Column 
-----------------------------------------------------------------------

### Methods

#### Data sources

Public Health England (PHE) collects data on all SARS-CoV-2 COVID-19 PCR tests taken in hospital laboratories across England. Laboratory data systems automatically feed into PHEâ€™s Second Generation Surveillance System (SGSS) daily.  A weekly extract of all Pillar 1 cases, those with medical need and critical key workers, is taken. 

The National Health Service (NHS) collect data on all hospital attendances and admissions for payment by results. These data are collated by NHS Digital and sent daily to PHE via the Secondary uses Service (SUS) and Emergency Care Dataset (ECDS) data collections, on admitted patient stays, and Accident and Emergency (A&E) attendances, respectively.  

Data was extracted from all sources on `r file.info("./hcai.csv")$mtime`. 

#### Data preparation and linkage

Where a patient has multiple COVID-19 positive tests, the first positive test is retained. SUS data is presented in consultant episodes, where a patient in under the continuous care of a single consultant. Episodes are grouped into spells, a continuous inpatient stay within a single hospital provider. Length of stay is calculated by comparing admission and discharge dates of a hospital spell. 

Hospital records from SUS and ECDS are linked on NHS number, hospital number and date of birth where the A&E departure date matches an inpatient admission date within the same healthcare provider. These combined hospital records are linked to SGSS COVID-19 positive tests on either NHS number or hospital number and date of birth where the positive test was taken during a hospital admission or within 14 days prior to a hospital admission. 

Where a patient has had multiple hospital admissions, priority is given to: (1) tests taken during a hospital stay; (2) hospital inpatient stays over A&E attendances. Where a test is taken between two distinct hospital admissions, the stay prior to the positive test result is used.

#### HCAI Categories

Cases are presented in Healthcare associated infection (HCAI) categories (Table 2). Allocation to a HCAI category is calculated using the first positive COVID19 PCR test result per patient, paired with the date of admission for an inpatient hospital stay or an emergency care A&E attendance. 
Records are not allocated to an HCAI category where COVID19 positive tests have not linked to a hospital admission. In these unlinked cases, hospital provider sites are determined based on the reporting laboratory. Unlinked cases may be related to healthcare staff, outpatient or nursing home patients tested within the NHS or PHE laboratories who do not have a record on ECDS or SUS.


Questions: [Alex Bhattacharya](mailto:alex.bhattacharya@phe.gov.uk?subject=COVID%20%HCAI%20%Dashboard)


Column 
-----------------------------------------------------------------------

### Table 2: HCAI definitions


|Code       |HCAI Category                |Criteria                            |
|:----------|:----------------------------|:-----------------------------------|
|CO         | Community-Onset | Positive specimen date <=2 days after hospital admission|
|HO.iHA     | Hospital-Onset Indeterminate Healthcare-Associated	| Positive specimen date 3-7 days after hospital admission|
|HO.pHA     | Hospital-Onset Probable Healthcare-Associated	| Positive specimen date 8-14 days after hospital admission|
|HO.HA      | Hospital-Onset Definite Healthcare-Associated	| Positive specimen date 15 or more days after hospital admission|
|Unlinked   | Unlinked COVID19 Positive Specimen | No link was made between the positive test and a hospital stay; HCAI category cannot be established|


### Figure 3: HCAI visualisation


```{r hcai_group_method_visual}
renderPlot({
  
  vismethod <-
    tibble(
      hcai_group = c("CO", "HO.iHA", "HO.pHA", "HO.HA"),
      cat_start = c(-14, 2, 8, 14),
      cat_end = c(1.99 , 7.99, 13.99, 21),
      COVID19_pos = c(0, 0, 0, 0)
    ) %>%
    mutate(hcai_group = factor(hcai_group,
                               levels = c("CO",
                                          "HO.iHA",
                                          "HO.pHA",
                                          "HO.HA")
      )) %>%
    group_by(hcai_group) %>%
    mutate(label_pos = mean(c(cat_start, round(cat_end)))) %>%
    ggplot(aes(x = COVID19_pos, y = 1, label = hcai_group)) +
    geom_rect(aes(
      xmin = cat_start,
      xmax = cat_end,
      ymin = -1,
      ymax = 1,
      fill = hcai_group
    ),
    color = NA) +
    geom_label(aes(x = label_pos, y = 0.3), fill = "white") +
    geom_vline(aes(xintercept = COVID19_pos), color = "red") +
    annotate(
      "label",
      label = "Admission\nto hospital",
      x = 0,
      y = 1.3,
      fill = "red",
      alpha = 0.75
    ) +
    scale_x_continuous(
      "Days since positive COVID19 test",
      breaks = c(-14:21),
      limits = c(-14, 21)
    ) +
    scale_y_discrete("") +
    scale_shape_manual(values = "black") +
    scale_fill_manual(
      values = c(
        "#00B092",
        "#425563",
        "#EAAB00",
        "#822433"
      )
    ) +
    theme_classic() +
    theme(
      legend.position = "none",
      panel.grid = element_blank(),
      axis.ticks.y = element_blank(),
      panel.border = element_blank(),
      plot.margin = unit(c(1, 1, 2, 1), "lines")
    )
  

  print(vismethod)
})
```


